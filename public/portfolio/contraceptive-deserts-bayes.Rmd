---
title: "Spatial Bayesian Models of Contraceptive Deserts"
author: "Raven McKnight"
date: "5/10/2019"
output:
  blogdown:::html_document
---

### Common introduction 
### Case study: Contracpetive Deserts

Birth control is a critical aspect of basic health care. Accessible contraceptive services reduce unplanned pregnancies, lower abortion rates, and empower women to navigate the world and their health more freely. Over 20 million women in the United States are in need of publicly-funded birth control -- over 1 million of them live in a county without a single provider. 

This project was initially inspired by a map from [Power to Decide](https://powertodecide.org/what-we-do/access/access-birth-control). They define a *contraceptive desert* as an area where a single birth control provider must serve 1000 or more women in need. In this project, I model the ratio of *women in need of publicly funded services* per *clinic providing publicly funded services*. This is a naive metric, but I think an intuitive one in beginning to understand birth control accessibility. Admittedly, access is more nuanced than the simple presence of clinics. There are many other factors to consider: physical accessibility, stigma, under-education, or any other number of personal characteristics. Developing a better metric for accessibility is an exciting area for future work!

#### The data
For this project, I use data on birth control patients and providers from the Guttmacher Institute, demographics from the American Community Survey, and TIGER/Line shapefiles for state and county boundaries. We can read the cleaned birth control and demographic data from [my Github](https://github.com/ravenmcknight). 

```{r warning = FALSE, message=FALSE}
library(readr)

file <- "https://raw.github.com/ravenmcknight/contraceptive-deserts/master/contraceptive_deserts_may10"   # url for csv 
bc <- read_csv(file)
```

Now we have data for (almost) every county in the United States! I'll focus on the following variables: 

| **variable**                        | **meaning**                                                                                                               |
|-------------------------------------|---------------------------------------------------------------------------------------------------------------------------|
| WomenPerClinic                      | Women in need of publicly funded services/publicly funded clinics, Guttmacher 2015                                        |
| MedianInc                           | Median county income, ACS 2015                                                                                            |
| PercHSGrad                          | Percent of county with high school diploma or equivalent, ACS 2015                                                        |
| PercPoverty                         | Percent of county living below poverty line, ACS 2015                                                                     |
| PercWhite, PercBlack ....           | Seven variables recording racial demographics of each county, ACS 2015                                                    |
| PercRural                           | Percent of population living in rural area, ACS 2015                                                                      |

\ 

Because we have so much data, I'll also filter to get *just* counties in my home state, North Carolina. This will speed up our models and make visualization much easier!

```{r warning=FALSE, message=FALSE}
library(tidyverse)

nc <- bc %>%
  filter(State=="NorthCarolina")
```

If we want to visualize this data, we can join it to county shapefiles from the US Census. If you don't have it already, install the `tigris` package to get shapefiles without dealing with the census website. I'll also load the rest of the spatial packages we'll need here. One thing we need to be aware of when working with spatial data is the difference between `sp` and `sf` objects. They are not entirely interchangable, so I'll name my spatial objects with "sp" of "sf" at the end to keep them straight!

```{r warning=FALSE, message=FALSE, results="hide"}
library(tigris)
library(sp)
library(sf)
library(spdep)
library(ape)

nc_counties_sp <- counties(state="NC", cb=TRUE)   # cb = TRUE gives smaller files when possible to speed up mapping

nc_counties_sf <- st_as_sf(nc_counties_sp)

nc <- nc %>%
  mutate(GEOID = as.character(fips))  # Create a field to join on 

nc_sf <- full_join(nc_counties_sf, nc, by="GEOID")  # Join!

nc_sp <- as(nc_sf, "Spatial")  # Go ahead and make an sp for later
```

Now, we can start mapping! Let's look at the number of women per clinic across counties in North Carolina. 

```{r warning= FALSE, message=FALSE}
library(extrafont) # totally optional step to change default ggplot font!
#font_import()
#loadfonts()

# I can also save my ggplot themes to use throughout!

project_theme_map <- theme(text = element_text(family = "Oswald Light"), panel.grid.major = element_line("transparent"), axis.text=element_blank(), legend.direction="horizontal", legend.position="bottom", plot.title = element_text(hjust = 0.5), legend.key.width=unit(.8, "cm"))  

project_theme_plot <- theme(text = element_text(family = "Oswald Light"), legend.direction="horizontal", legend.position="bottom", plot.title = element_text(hjust = 0.5), legend.key.width=unit(.8, "cm"))  

project_colors <- scale_fill_gradient(low="#92b6b1", high="#666a86", na.value="#C0C0C0", guide="colorbar")

ggplot() +
  geom_sf(data=nc_sf, aes(fill=WomenPerClinic), color=NA) +
  labs(title = "Accessibility in North Carolina") +
  guides(fill=guide_colorbar(title="Women Per Clinic")) + 
  theme_minimal() +
  project_colors +
  project_theme_map
```

With this map, we can start to identify counties with particularly high patient-to-clinic ratios. My goal in this project is to use spatial Bayesian models to identify clusters of limited access to birth control. 

#### Spatial autocorrelation?

Before we go on with spatial modeling, we should confirm that our data isn't spatially random. If it *is*, then we don't need to use spatial methods. We can check for spatial autocorrelation using Moran's I. If Moran's I is close to 1, we have positive spatial autocorrelation (clustering) and if it's close to 0, we have negative autocorelation (repulsion). 

We can check if our data is spatially random by randomly assigning values to each county in North Carolina 10000 times and taking the Moran's I of each simulation. Then, we compare our *real* data to the simulated data. If our data is "less random" than any of our simulations, we can feel confident that we need to use spatial methods. 


```{r}
set.seed(454)
nc_nb <- poly2nb(nc_sf)   
nc_w <- nb2listw(nc_nb, style="B")

moran.mc(na.omit(nc_sp$WomenPerClinic), nc_w, nsim = 9999) # markov chain simulations
```

This test tells us that our real data is not *the least* random, but it is less random than about 98% of the simulations with slight positive spatial autocorrelation. My guess is that we would see stronger spatial autocorrelation if we looked at the entire country, or at North Carolina by census tract. Either way, Moran's I confirms that we should be using spatial methods!


#### A Familiar Model & Variable Selection

Before trying to identify clusters of limited access, I decided to fit a model with more familiar interpretations. By fitting the CAR model proposed in 2000 by Leroux, we can get coefficients on each of our predictors to get a sense of how they are related to access. First, we can check out the distribution of our predictors and their relationship with women per clinic. 

```{r}
predictors <- na.omit(as.data.frame(nc)) %>%
  dplyr::select(WomenPerClinic, MedianInc, PercHSGrad, PercPoverty, PercWhite, PercRural)

titles <- c(
                    `MedianInc` = "Median Income",
                    `PercHSGrad` = "Percent High School Graduates", 
                    `PercPoverty` = "Percent in Poverty", 
                    `PercRural` = "Percent Rural", 
                    `PercWhite` = "Percent White",
                    `WomenPerClinic` = "Women Per Clinic"
                    )

predictors %>%
  gather(key="var", value = "value") %>%
  ggplot(aes(x=value)) + 
    geom_density(fill="#788aa3", color="#788aa3") +
    facet_wrap(~var, scales= "free", labeller = as_labeller(titles)) +
    theme_minimal() +
    project_theme_plot

predictors %>%
  gather(-WomenPerClinic, key = "var", value = "value") %>%
  ggplot(aes(x = value, y = WomenPerClinic)) +
    geom_point(color="#b2c9ab") +
    facet_wrap(~ var, scales = "free", labeller = as_labeller(titles)) +
    theme_minimal() +
    project_theme_plot 
```

To better understand these relationships, I'll fit a Leroux model using each of these five predictors so we can see which are most "important." For more information on models like this, you can check out **Katie's post here**. She fits BYM models which are the precursor to Leroux! I chose to use Leroux rather than BYM because its R implementation is more suited to continuous or Gaussian response variables (vignette, page 4-5). The Leroux model is essentially an extension of the BYM model -- it's main advantage is that it handles *overdispersion* with a specific parameter. Overdispersion occurs when there is more variability in the data than we expect for a given model or data structure. This can occur fairly frequently with "real-world" spatial data, so Leroux offers an advantage in many cases. 


We'll need the CARBayes package to implement our CAR models. This package includes seven main functions, each of which corresponds to a different model with different priors and model structures. For more technical explanation of the entire package, check out the [vignette](https://cran.r-project.org/web/packages/CARBayes/vignettes/CARBayes.pdf). 

The last thing we need to start fitting models is a *neighborhood structure*. This model uses a queen neighborhood structure. This means that any two counties that share a single point of contact are considered neighbors. 

```{r include = FALSE}
# might be nice to have an image of this and what is spatial data
```

```{r results = "hide"}
library(CARBayes)

formula <- WomenPerClinic ~ MedianInc + PercHSGrad + PercPoverty + PercRural + PercWhite   # Our model formula

nc_sp_mod <- nc_sp[which(!is.na(nc_sp$WomenPerClinic)), ] # remove county with na values
nc_sp_mod <- nc_sp[which(!is.na(nc_sp$PercWhite)), ] # and missing demographic data

W.nb <- poly2nb(nc_sp_mod, row.names=rownames(nc_sp_mod), queen=TRUE)   # Create neighborhood matrix
W.list <- nb2listw(W.nb, style="B")
W <- nb2mat(W.nb, style="B") 

nc_leroux <- S.CARleroux(formula=formula, data=nc_sp_mod, family="gaussian", W=W, burnin=100000, n.sample=300000, thin=20)
```
```{r}
print(nc_leroux)
```


The good news: we have coefficients! The bad news: the 95% coverage interval of almost coefficient includes zero. This means that we can't confidently conlude that percent of high school graduates has a positive correlation with women per clinic (for example). Ignoring the significance of the predictors for a moment, the quick takeaways from this model are

* Median income, percent high school graduates, percent living in poverty, and percent white are correlated with *higher* ratios of women per clinic -- ie, worse access to birth control. 
* Percent rural is the only predictor correlated with lower ratios, and the only predictor whose coverage interval does not include zero. This seems significant but is primarily because very rural counties don't have enough women in need to count as a desert by our metric! This reveals the major weakness of this analysis. 


It may be more informative to fit a model without percent rural: 
```{r results="hide"}
formula_2 <- WomenPerClinic ~ MedianInc + PercHSGrad + PercPoverty + PercWhite

nc_leroux_2 <- S.CARleroux(formula=formula_2, data=nc_sp_mod, family="gaussian", W=W, burnin=100000, n.sample=300000, thin=20)
```

```{r}
print(nc_leroux_2)
```

This is more like it! The coverage intervals for percent in poverty and percent white still cross zero, but the coefficients make a bit more sense: 

* Median income and percent high school graduates are positively correlated with women per clinic, likely because education and income tend to be concentrated in more populous, urban areas
* Poverty is positively correlated with women per clinic
* Higher percentages of white residents are *negatively* correlated with women per clinic -- ie, white areas have better access to birth control. This is a result I expected to see! 

With all of this in mind, we're ready to start identifying clusters!

#### Boundary Detection 

To answer my intial question -- can we identify clusters of limited access to birth control -- I'll use the boundary detection CAR model proposed by Lee and Mitchell in 2012. This model uses a *dissimilarity metric* to identify spatial breaks in our data. 


